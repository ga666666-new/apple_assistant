import{d as Me,v as $e,h as w,c as ke,z as Fe,D as Ce,a as _,o as g,e as l,aI as Ie,w as r,b as c,aJ as Le,x as v,t as n,aK as De,m as N,ak as Ne,F as X,r as Y,aL as Ve,B as be,aM as Ee,f as j,aN as Ae,aO as ze,y as Oe,n as Te,aP as Je,S as Ue,aQ as Be,aR as Re,aS as Pe,al as qe,aT as je,aU as Ke,aV as xe,M as m,A as F,_ as We}from"./index-lNCLxOJp.js";import{v as Z}from"./v4-BWNhe68K.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              */const Ge={class:"file-manager-container"},He={class:"desktop-app-info"},Qe={class:"upload-section"},Xe={class:"upload-content"},Ye={class:"upload-text"},Ze={class:"primary-text"},ea={class:"secondary-text"},aa={key:0,class:"current-upload-list"},ta={class:"file-items"},la={class:"file-info"},oa={class:"file-details"},sa={class:"file-name"},na={class:"file-meta"},ia={class:"file-actions"},ra={key:0,class:"upload-progress"},da={class:"file-status"},ca={key:0,class:"merge-section"},ua={class:"merge-info"},pa={key:1,class:"save-section"},va={class:"saved-files-header-title"},ga={class:"saved-files-section"},fa={key:0,class:"empty-state"},ma={key:1,class:"saved-files-list"},ha={class:"saved-file-info"},_a={class:"saved-file-header"},ya={class:"saved-file-actions"},Sa={class:"saved-file-meta"},wa={key:0},Ma={class:"file-preview"},$a=Me({__name:"index",setup(ka){const{t:y}=$e.useI18n(),T=w(!1),i=w([]),d=w([]),K=w(),V=w(!1),C=w(""),b=w(!1),B=w(!1),M=w({name:"",description:""}),f=w({id:"",name:"",description:""}),x=ke(()=>{const e=i.value?.some(a=>a.status==="success")||!1;return console.log("🔄 canSave计算:",{uploadedFilesCount:i.value?.length||0,successFiles:i.value?.filter(a=>a.status==="success").length||0,canSave:e,allStatuses:i.value?.map(a=>({name:a.name,status:a.status}))||[]}),e}),ee=e=>{if(e===0)return"0 B";const a=1024,t=["B","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(a));return`${parseFloat((e/a**o).toFixed(2))} ${t[o]}`},ae=e=>new Date(e).toLocaleString(),te=e=>new Promise((a,t)=>{const o=new FileReader;o.onload=p=>a(p.target?.result),o.onerror=t,o.readAsText(e,"utf-8")}),W=async e=>{const a=i.value.findIndex(o=>o.id===e);if(a===-1){console.error("❌ 找不到文件:",e);return}const t=i.value[a];console.log("📁 开始处理文件:",t.name);try{i.value[a]={...t,status:"uploading",progress:10},await F();const o=await te(t.file);i.value[a]={...i.value[a],progress:40},await F();const p=o.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`),S=p.filter(u=>u.trim().length>0);i.value[a]={...i.value[a],progress:70,totalLines:p.length,validLines:S.length,data:S},await F(),await new Promise(u=>setTimeout(u,300)),i.value[a]={...i.value[a],progress:90},await F(),i.value[a]={...i.value[a],progress:100,status:"success"},await F(),console.log("✅ 文件处理完成:",{name:i.value[a].name,status:i.value[a].status,totalLines:i.value[a].totalLines,validLines:i.value[a].validLines}),console.log("🔄 处理完成后，canSave:",x.value),m.success(`文件 ${i.value[a].name} 处理完成，共 ${i.value[a].validLines} 条有效数据`)}catch(o){console.error("❌ 文件处理失败:",t.name,o),i.value[a]={...i.value[a],status:"error"},await F(),m.error(`文件 ${t.name} 处理失败`)}},le=async e=>W(e.id),G=async e=>{const a=e.filter(t=>t.name.match(/\.(txt|csv)$/i)&&t.size<=104857600);for(const t of a){const o={id:Z(),name:t.name,size:t.size,file:t,status:"uploading",progress:0,totalLines:0,validLines:0,data:[]};i.value.push(o),await W(o.id)}},oe=e=>{e.preventDefault(),T.value=!0},se=e=>{e.preventDefault(),T.value=!1},ne=e=>{e.preventDefault(),T.value=!1;const a=Array.from(e.dataTransfer?.files||[]);G(a)},ie=()=>{K.value?.click()},re=e=>{const a=e.target,t=Array.from(a.files||[]);G(t),a.value=""},de=e=>{i.value.splice(e,1)},H=()=>{i.value=[],M.value={name:"",description:""}},ce=async e=>{e.status="uploading",e.progress=0,await le(e)},ue=e=>{const a=e.data.slice(0,10);C.value=a.join(`
`),e.data.length>10&&(C.value+=`

... 还有 ${e.data.length-10} 行数据`),V.value=!0},pe=e=>{const a=e.data.slice(0,10);C.value=a.join(`
`),e.data.length>10&&(C.value+=`

... 还有 ${e.data.length-10} 行数据`),V.value=!0},ve=async()=>{if(!M.value.name.trim()){m.error(y("fileManager.upload.saveNameRequired"));return}B.value=!0;try{const e=[],a=[];i.value.forEach(I=>{I.status==="success"&&(e.push(...I.data),a.push(I.name))});const t=[...new Set(e)],o={id:Z(),name:M.value.name.trim(),description:M.value.description.trim(),data:t,totalLines:t.length,createdAt:Date.now(),updatedAt:Date.now()};if(typeof localStorage>"u")throw new Error("localStorage不可用，无法保存数据");const p=JSON.parse(localStorage.getItem("savedFiles")||"[]");p.push(o),localStorage.setItem("savedFiles",JSON.stringify(p));const S=JSON.parse(localStorage.getItem("savedFiles")||"[]");console.log("保存前数据集数量:",p.length-1),console.log("保存后数据集数量:",S.length),console.log("新保存的数据集:",{id:o.id,name:o.name,totalLines:o.totalLines,description:o.description});const u={savedFileId:o.id,originalFiles:a,savedPath:`./data/saved-files/${o.id}.txt`,processedAt:new Date().toISOString()};console.log("文件保存信息:",u),console.log(`已保存 ${t.length} 条数据到: ${u.savedPath}`),typeof window<"u"&&window.dispatchEvent(new CustomEvent("savedFilesUpdated",{detail:{savedFiles:S}})),d.value.push(o),console.log("🔄 当前页面数据集列表已更新，总数:",d.value.length),await F(),setTimeout(()=>{console.log("🔍 保存后验证 - 页面显示数据集数量:",d.value.length),console.log("🔍 保存后验证 - localStorage数据集数量:",JSON.parse(localStorage.getItem("savedFiles")||"[]").length)},100),H(),m.success(`${y("fileManager.upload.saveSuccess")} - 共保存 ${t.length} 条数据`)}catch(e){console.error("保存文件时出错:",e),m.error(y("fileManager.upload.saveError"))}finally{B.value=!1}},ge=e=>{f.value={id:e.id,name:e.name,description:e.description||""},b.value=!0},fe=()=>{if(!f.value.name.trim()){m.error(y("fileManager.edit.nameRequired"));return}const e=d.value.findIndex(a=>a.id===f.value.id);e!==-1&&(d.value[e].name=f.value.name.trim(),d.value[e].description=f.value.description.trim(),d.value[e].updatedAt=Date.now(),typeof localStorage<"u"&&localStorage.setItem("savedFiles",JSON.stringify(d.value)),console.log("📝 数据集信息已更新:",{id:f.value.id,newName:f.value.name.trim(),newDescription:f.value.description.trim()}),typeof window<"u"&&window.dispatchEvent(new CustomEvent("savedFilesUpdated",{detail:{savedFiles:d.value}})),m.success(y("fileManager.edit.updateSuccess"))),b.value=!1},me=()=>{b.value=!1,f.value={id:"",name:"",description:""}},he=(e,a)=>{console.log("🗑️ 删除数据集:",{id:e.id,name:e.name,index:a}),d.value.splice(a,1),typeof localStorage<"u"&&localStorage.setItem("savedFiles",JSON.stringify(d.value)),console.log("✅ 数据集删除完成，剩余:",d.value.length,"个"),typeof window<"u"&&window.dispatchEvent(new CustomEvent("savedFilesUpdated",{detail:{savedFiles:d.value}})),m.success(y("fileManager.saved.deleteSuccess"))},_e=e=>{console.log("➕ 追加到数据集:",{id:e.id,name:e.name,currentLines:e.totalLines});const a=document.createElement("input");a.type="file",a.accept=".txt,.csv",a.style.display="none",a.onchange=t=>{const o=t.target.files[0];if(!o)return;const p=o.name.toLowerCase();if(!p.endsWith(".txt")&&!p.endsWith(".csv")){m.error(y("fileManager.upload.fileTypeError"));return}const S=new FileReader;S.onload=u=>{const $=(u.target?.result).split(`
`).filter(k=>k.trim()),E=e.data,L=[...E,...$],h=Array.from(new Set(L)),P={...e,data:h,totalLines:h.length,updatedAt:Date.now()};try{const A=JSON.parse(localStorage.getItem("savedFiles")||"[]").map(U=>U.id===e.id?P:U);localStorage.setItem("savedFiles",JSON.stringify(A)),d.value=A;const z=$.length,O=$.length-(h.length-E.length);O>0?m.success(y("fileManager.saved.appendResult",{fileName:e.name,added:z,duplicate:O,total:h.length})):m.success(y("fileManager.saved.appendSuccess",{fileName:e.name,added:z,total:h.length})),typeof window<"u"&&window.dispatchEvent(new CustomEvent("savedFilesUpdated",{detail:{action:"append",fileId:e.id}})),console.log("✅ 追加完成:",{fileName:e.name,added:z,duplicate:O,total:h.length})}catch(k){console.error("❌ 追加文件时出错:",k),m.error(y("fileManager.saved.appendError"))}},S.onerror=()=>{m.error(y("fileManager.upload.fileReadError"))},S.readAsText(o,"utf-8")},document.body.appendChild(a),a.click(),document.body.removeChild(a)},J=()=>{try{if(typeof localStorage>"u"){console.warn("⚠️ localStorage不可用，无法加载数据集"),d.value=[];return}const e=JSON.parse(localStorage.getItem("savedFiles")||"[]");console.log("📁 文件管理页面加载数据集:",{timestamp:new Date().toLocaleString(),count:e.length,datasets:e.map(a=>({id:a.id,name:a.name,totalLines:a.totalLines}))}),d.value=e,console.log("✅ 文件管理页面数据集更新完成，当前显示:",d.value.length,"个数据集")}catch(e){console.error("❌ 文件管理页面加载数据集时出错:",e),d.value=[]}},ye=()=>{console.log("🔄 强制重载数据..."),d.value=[];const e=R();console.log("🏥 重载前健康检查:",e),J(),setTimeout(()=>{console.log("🔍 强制重载后验证:"),console.log("  - 页面显示数据集数量:",d.value.length);const a=localStorage.getItem("savedFiles");if(a){const t=JSON.parse(a);console.log("  - localStorage数据集数量:",t.length),t.length>0&&d.value.length===0?(console.error("❌ 数据加载失败！localStorage有数据但页面没有显示"),console.log("🔧 尝试直接赋值..."),d.value=t):t.length===d.value.length&&console.log("✅ 数据加载成功")}},100),m.info("数据重载完成")},R=()=>{try{if(typeof localStorage>"u")return console.warn("⚠️ localStorage不可用"),{healthy:!1,error:"localStorage not available"};const e="ls-test";localStorage.setItem(e,"test"),localStorage.removeItem(e);const a=localStorage.getItem("savedFiles");if(!a)return console.log("ℹ️ localStorage中暂无savedFiles数据"),{healthy:!0,dataExists:!1};const t=JSON.parse(a);if(!Array.isArray(t))return console.warn("⚠️ savedFiles数据格式异常，不是数组"),{healthy:!1,error:"Invalid data format"};const o=t.filter(p=>!p.id||!p.name||!p.data||!Array.isArray(p.data));return o.length>0?(console.warn("⚠️ 发现无效的数据项:",o),{healthy:!1,error:"Invalid data items",invalidItems:o}):(console.log("✅ localStorage数据健康检查通过"),{healthy:!0,dataExists:!0,count:t.length})}catch(e){return console.error("❌ localStorage健康检查失败:",e),{healthy:!1,error:e?.message||"Unknown error"}}};return Fe(()=>{console.log("🚀 文件管理页面正在挂载...");const e=R();console.log("🏥 localStorage健康检查:",e),J(),setTimeout(()=>{console.log("📊 加载后立即验证:"),console.log("  - 页面显示数据集数量:",d.value.length),console.log("  - localStorage原始数据:",localStorage.getItem("savedFiles")?.length||0,"字符");const a=localStorage.getItem("savedFiles");if(a)try{const t=JSON.parse(a);console.log("  - localStorage解析后数量:",t.length),console.log("  - 数据项示例:",t.slice(0,2))}catch(t){console.error("  - localStorage数据解析失败:",t)}},100),setTimeout(()=>{try{console.log("🔍 执行数据完整性检查...");const a=R();if(console.log("🏥 健康检查结果:",a),typeof localStorage<"u"){const t=localStorage.getItem("savedFiles"),o=t?JSON.parse(t):[];console.log("🔍 原始localStorage数据长度:",t?.length||0),console.log("🔍 解析后的数据集数量:",o.length),console.log("🔍 页面显示的数据集数量:",d.value.length),o.length!==d.value.length?(console.warn("⚠️ 数据不同步！localStorage:",o.length,"页面显示:",d.value.length),console.log("🔄 重新加载数据..."),J()):console.log("✅ 数据同步正常")}else console.warn("⚠️ localStorage不可用，跳过数据验证")}catch(a){console.error("❌ 数据验证过程出错:",a)}},1e3)}),(e,a)=>{const t=De,o=Le,p=Ce("icon-cloud-upload"),S=Ve,u=be,I=Ee,$=Ae,E=ze,L=Je,h=Te,P=Ue,k=Oe,A=Be,z=qe,O=je,U=Re,Se=Pe,we=Ke,Q=xe;return g(),_("div",Ge,[l(Ie,{items:["menu.fileManager","menu.fileManager.upload"]}),l(A,{class:"general-card",title:e.$t("fileManager.upload.title")},{default:r(()=>[c("div",He,[l(o,{type:"info","show-icon":!1},{icon:r(()=>[l(t)]),default:r(()=>[v(" "+n(e.$t("fileManager.upload.desktopTip")),1)]),_:1})]),c("div",Qe,[c("div",{class:Ne(["upload-area",{"drag-over":T.value,"has-files":i.value.length>0}]),onDrop:ne,onDragover:oe,onDragleave:se,onClick:ie},[c("div",Xe,[l(p,{class:"upload-icon",size:48}),c("div",Ye,[c("div",Ze,n(e.$t("fileManager.upload.dragTip")),1),c("div",ea,n(e.$t("fileManager.upload.fileLimit")),1)])]),c("input",{ref_key:"fileInput",ref:K,type:"file",accept:".txt,.csv",multiple:"",style:{display:"none"},onChange:re},null,544)],34),i.value.length>0?(g(),_("div",aa,[c("h3",null,n(e.$t("fileManager.upload.currentFiles")),1),c("div",ta,[(g(!0),_(X,null,Y(i.value,(s,q)=>(g(),_("div",{key:s.id,class:"file-item"},[c("div",la,[l(S,{class:"file-icon"}),c("div",oa,[c("div",sa,n(s.name),1),c("div",na,n(ee(s.size))+" | "+n(e.$t("fileManager.upload.totalLines"))+": "+n(s.totalLines)+" | "+n(e.$t("fileManager.upload.validLines"))+": "+n(s.validLines),1)])]),c("div",ia,[l(u,{size:"mini",type:"text",onClick:D=>ue(s)},{default:r(()=>[v(n(e.$t("fileManager.upload.preview")),1)]),_:2},1032,["onClick"]),l(u,{size:"mini",type:"text",status:"danger",onClick:D=>de(q)},{default:r(()=>[v(n(e.$t("fileManager.upload.delete")),1)]),_:2},1032,["onClick"])]),s.status==="uploading"?(g(),_("div",ra,[l(I,{percent:s.progress},null,8,["percent"])])):N("",!0),c("div",da,[s.status==="success"?(g(),j($,{key:0,color:"green"},{default:r(()=>[v(n(e.$t("fileManager.upload.uploadSuccess")),1)]),_:1})):s.status==="error"?(g(),j($,{key:1,color:"red"},{default:r(()=>[v(n(e.$t("fileManager.upload.uploadFailed"))+" ",1),l(u,{size:"mini",type:"text",onClick:D=>ce(s)},{default:r(()=>[v(n(e.$t("fileManager.upload.retry")),1)]),_:2},1032,["onClick"])]),_:2},1024)):s.status==="uploading"?(g(),j($,{key:2,color:"blue"},{default:r(()=>[v(n(e.$t("fileManager.upload.uploading")),1)]),_:1})):N("",!0)])]))),128))]),i.value.length>1?(g(),_("div",ca,[l(E),c("div",ua,[l(o,{type:"info","show-icon":!1},{default:r(()=>[v(n(e.$t("fileManager.upload.mergeInfo",{count:i.value.length})),1)]),_:1})])])):N("",!0),x.value?(g(),_("div",pa,[l(E),l(k,{model:M.value,layout:"inline"},{default:r(()=>[l(h,{label:e.$t("fileManager.upload.saveName"),field:"name",rules:[{required:!0,message:e.$t("fileManager.upload.saveNameRequired")}]},{default:r(()=>[l(L,{modelValue:M.value.name,"onUpdate:modelValue":a[0]||(a[0]=s=>M.value.name=s),placeholder:e.$t("fileManager.upload.saveNamePlaceholder"),style:{width:"200px"}},null,8,["modelValue","placeholder"])]),_:1},8,["label","rules"]),l(h,{label:e.$t("fileManager.upload.description"),field:"description"},{default:r(()=>[l(L,{modelValue:M.value.description,"onUpdate:modelValue":a[1]||(a[1]=s=>M.value.description=s),placeholder:e.$t("fileManager.upload.descriptionPlaceholder"),style:{width:"300px"}},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),l(h,null,{default:r(()=>[l(P,null,{default:r(()=>[l(u,{type:"primary",onClick:ve,loading:B.value},{default:r(()=>[v(n(e.$t("fileManager.upload.save")),1)]),_:1},8,["loading"]),l(u,{onClick:H},{default:r(()=>[v(n(e.$t("fileManager.upload.clear")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])])):N("",!0)])):N("",!0)])]),_:1},8,["title"]),l(A,{class:"general-card",style:{"margin-top":"16px"}},{title:r(()=>[c("div",va,[c("span",null,n(e.$t("fileManager.saved.title")),1),l(u,{size:"mini",type:"outline",onClick:J},{default:r(()=>[l(z),v(" "+n(e.$t("fileManager.saved.refresh")),1)]),_:1}),l(u,{size:"mini",type:"outline",onClick:ye},{default:r(()=>[l(O),a[8]||(a[8]=v(" 强制重载 "))]),_:1})])]),default:r(()=>[c("div",ga,[d.value.length===0?(g(),_("div",fa,[l(U,{description:e.$t("fileManager.saved.empty")},null,8,["description"])])):(g(),_("div",ma,[(g(!0),_(X,null,Y(d.value,(s,q)=>(g(),_("div",{key:s.id,class:"saved-file-item"},[c("div",ha,[c("div",_a,[c("h4",null,n(s.name),1),c("div",ya,[l(u,{size:"mini",type:"outline",onClick:D=>pe(s)},{default:r(()=>[v(n(e.$t("fileManager.saved.preview")),1)]),_:2},1032,["onClick"]),l(u,{size:"mini",type:"outline",onClick:D=>ge(s)},{default:r(()=>[v(n(e.$t("fileManager.saved.edit")),1)]),_:2},1032,["onClick"]),l(u,{size:"mini",type:"outline",onClick:D=>_e(s)},{default:r(()=>[l(Se),v(" "+n(e.$t("fileManager.saved.append")),1)]),_:2},1032,["onClick"]),l(u,{size:"mini",type:"outline",status:"danger",onClick:D=>he(s,q)},{default:r(()=>[v(n(e.$t("fileManager.saved.delete")),1)]),_:2},1032,["onClick"])])]),c("div",Sa,[c("span",null,n(e.$t("fileManager.saved.totalLines"))+": "+n(s.totalLines),1),c("span",null,n(e.$t("fileManager.saved.createdAt"))+": "+n(ae(s.createdAt)),1),s.description?(g(),_("span",wa,n(e.$t("fileManager.saved.description"))+": "+n(s.description),1)):N("",!0)])])]))),128))]))])]),_:1}),l(Q,{visible:V.value,"onUpdate:visible":a[4]||(a[4]=s=>V.value=s),title:e.$t("fileManager.preview.title"),width:"600px"},{footer:r(()=>[l(u,{onClick:a[3]||(a[3]=s=>V.value=!1)},{default:r(()=>[v(n(e.$t("fileManager.preview.close")),1)]),_:1})]),default:r(()=>[c("div",Ma,[l(we,{modelValue:C.value,"onUpdate:modelValue":a[2]||(a[2]=s=>C.value=s),rows:10,readonly:""},null,8,["modelValue"])])]),_:1},8,["visible","title"]),l(Q,{visible:b.value,"onUpdate:visible":a[7]||(a[7]=s=>b.value=s),title:e.$t("fileManager.edit.title"),onOk:fe,onCancel:me},{default:r(()=>[l(k,{model:f.value},{default:r(()=>[l(h,{label:e.$t("fileManager.edit.name"),field:"name",rules:[{required:!0,message:e.$t("fileManager.edit.nameRequired")}]},{default:r(()=>[l(L,{modelValue:f.value.name,"onUpdate:modelValue":a[5]||(a[5]=s=>f.value.name=s)},null,8,["modelValue"])]),_:1},8,["label","rules"]),l(h,{label:e.$t("fileManager.edit.description"),field:"description"},{default:r(()=>[l(L,{modelValue:f.value.description,"onUpdate:modelValue":a[6]||(a[6]=s=>f.value.description=s)},null,8,["modelValue"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["visible","title"])])}}}),Va=We($a,[["__scopeId","data-v-e1fae4a5"]]);export{Va as default};
